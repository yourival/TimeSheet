@model TimeSheet.Models.LeaveApplicationViewModel

@{
    string[] LeaveNames = {"Sick Leave", "Flexi Leave", "Annual Leave" };
}

<div class="hrForm-content">
    <div>
        @using (Html.BeginForm("Index", "LeaveApplication", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(model => model.LeaveApplication.UserID)
            <div>
                <label>Balance (hrs):&nbsp;</label>
                <text class="textStyleBefore">
                    @for (int i = 0; i < 3; i++)
                    {
                        @LeaveNames[i]
                        @:   :&nbsp;

                        <span class="lefthours">@Html.DisplayFor(m => m.LeaveRecords[i].AvailableLeaveHours)</span>

                        if (i != 2)
                        {
                            @: ,&nbsp;&nbsp;
                        }
                    }
                </text>

            </div>
            <hr>
            <form id="#lform">
                <div class="form-group">
                    <label class="col-sm-offset-1 col-sm-2" for="startTime">
                        @Html.LabelFor(model => model.LeaveApplication.StartTime)
                    </label>
                    <div class="col-sm-8">
                        <p>
                            @Html.EditorFor(model => model.LeaveApplication.StartTime, new { htmlAttributes = new { @class = "form-control", @id = "start" } })
                            @Html.ValidationMessageFor(model => model.LeaveApplication.StartTime, "", new { @class = "text-danger" })
                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-offset-1 col-sm-2" for="endTime">
                        @Html.LabelFor(model => model.LeaveApplication.EndTime)
                    </label>
                    <div class="col-sm-8">
                        <p>
                            @Html.EditorFor(model => model.LeaveApplication.EndTime, new { htmlAttributes = new { @class = "form-control", @id = "end" } })
                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-offset-1 col-sm-2" for="type">
                        @Html.LabelFor(model => model.LeaveApplication.leaveType)
                    </label>
                    <div class="col-sm-8">
                        <p>
                            @Html.DropDownListFor(model => model.LeaveApplication.leaveType, (IEnumerable<SelectListItem>)ViewBag.LeaveType, htmlAttributes: new { @class = "form-control", @id = "leavetypeMain" })
                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-offset-1 col-sm-2" for="manager">
                        @Html.Label("Manager")
                    </label>
                    <div class="col-sm-8">
                        <p>
                            @Html.DropDownList("manager", (IEnumerable<SelectListItem>)ViewBag.Manager, htmlAttributes: new { @class = "form-control" })
                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-offset-1 col-sm-2" for="comment">
                        @Html.LabelFor(model => model.LeaveApplication.Comment)
                    </label>
                    <div class="col-sm-8">
                        <p>
                            @Html.EditorFor(model => model.LeaveApplication.Comment, new { htmlAttributes = new { @class = "form-control", @id = "comment", @style = "resize: vertical" } })
                        </p>
                    </div>
                </div>
                <div class="row" align="right">
                    <div class="col-sm-offset-1 col-sm-10">
                        <a href="#leaveDetail" data-toggle="collapse">
                            <p>
                                Click here if you want to edit details
                                <span class="glyphicon glyphicon-pencil"></span>

                            </p>
                        </a>
                    </div>
                </div>

                <div class="appDetails">
                    <div class="col-sm-offset-1 col-sm-2"></div>
                    <div id="leave-form" class="col-sm-8"></div>
                </div>
                <hr/>
                <div class="row" align="right">
                    <div class="col-sm-offset-1 col-sm-10">
                        <label>Balance After (hrs):&nbsp;</label>
                        <text class="textStyleAfter">
                            @for (int i = 0; i < 3; i++)
                            {
                                @LeaveNames[i]
                                @:   :&nbsp;

                                <span class="lefthours">@Html.DisplayFor(m => m.LeaveRecords[i].AvailableLeaveHours)</span>

                                if (i != 2)
                                {
                                    @: ,&nbsp;&nbsp;
                            }
                            }
                        </text>
                    </div>
                </div>
                <div class="row" align="right">
                    <div class="col-sm-offset-1 col-sm-10">
                            <label>Total:</label>
                            <span id="total"></span>
                    </div>
                </div>
                <div class="button-group">
                    <input type="submit" value="Submit" id="submit-btn" class="btn btn-primary" />
                </div>
            </form>
        }
    </div>
</div>

<script src="~/Scripts/jquery-3.1.1.js"></script>
<script>
    function renderLeaveForm() {
        var start = $('#start').val();
        var end = $('#end').val();
        var leavetypeMain = $('#leavetypeMain').val();


        //Clear previous validation message
        $("#leave-form").removeData("validator");
        $("#leave-form").removeData("unobtrusiveValidation");

        $.ajax({
            url: "/LeaveApplication/CreateLeaveForm",
            type: "GET",
            data: { start: start, end: end, leaveType: leavetypeMain }
        })
        .done(function (partialViewResult) {
            //Render partial view
            $("#leave-form").html(partialViewResult);

            //Enable jquery validation
            $.validator.unobtrusive.parse("#leave-form");

            // When there is any change on detail leave time
            $(".leavetime").on("change", function () {
                sumLeavesByType();
                var total = sumTotalHours();
                $("#total").text(total + " (" + total / 7.5 + " days)");
            });

            sumLeavesByType();
            var total = sumTotalHours();
            $("#total").text(total + " (" + total / 7.5 + " day" + ((total / 7.5 > 1)?"s":"") + ")");
        });
    }

    function getFormattedDate(date) {
        var year = date.getFullYear();
        var month = (1 + date.getMonth()).toString();
        month = month.length > 1 ? month : '0' + month;
        var day = date.getDate().toString();
        day = day.length > 1 ? day : '0' + day;
        return year + '-' + month + '-' + day;
    }

    function sumLeavesByType() {
        var leavetypes = $(".leavetype");
        var leavetimes = $(".leavetime");
        var length = leavetimes.length;
        var lefthoursBefore = [];
        var lefthours = [];
        $(".textStyleBefore").children(".lefthours").each(function (i) {
            lefthours.push($(this).text());
            lefthoursBefore.push($(this).text());
        });

        for (var i = 0; i < length; i++) {
            lefthours[$(leavetypes[i]).val() - 1] -= $(leavetimes[i]).val();
        }

        $(".textStyleAfter").children(".lefthours").each(function (i) {
            $(this).text(lefthours[i]);
            if (lefthours[i] == lefthoursBefore[i]) {
                $(this).attr("class", "lefthours");
            } else if (lefthours[i] < 0) {
                $(this).attr("class", "lefthours excess");
            } else {
                $(this).attr("class", "lefthours modified");
            }
        });
    }

    function sumTotalHours() {
        var total = 0;
        $(".leavetime").each(function (i) {
            total += parseFloat($(this).val());
        });
        return total;
    }

    $(document).ready(function () {
        var fullDate = new Date();

        $("#start").val(getFormattedDate(new Date()));
        $("#end").val(getFormattedDate(new Date()));
        renderLeaveForm();
        // When there is any change on main panel
        $("#start").on("change", function () {
            if ($("#start").val() > $("#end").val())
                $("#end").val($("#start").val());
            renderLeaveForm();
        });
        $("#end").on("change", function () {
            if ($("#start").val() > $("#end").val())
                $("#start").val($("#end").val());
            renderLeaveForm();
        });
        $("#leavetypeMain").on("change", function () {
            renderLeaveForm();
        });

        // When the form is submitted
        $("form").submit(function (e) {
            // Test if applied leave times excess available leave balance
            $(".textStyleAfter").children(".lefthours").each(function (i) {
                if ($(this).text() < 0) {
                    $("#alert").attr('class', "alert alert-danger");
                    $("#alert").html('<span class="glyphicon glyphicon-exclamation-sign" style="color:#a94442""></span>' +
                        "Your leaves application excesses your leave balance.  " +
                        "<br>Please change them up and try submitting again");
                    e.preventDefault(e);
                    return false;
                }
            });
            
            //$("#alert").attr('class', "alert alert-success");
            //$("#alert").text("Successfully submitted" + msg);            
        });
    });
</script>
